SELECT
    (SELECT TOP 1
        T.NOME
    FROM TWFITAR TAR
    INNER JOIN TWFITAR_ELEMENTO T ON T.IDINSTPRN = TAR.IDINSTPRN AND T.IDINSTTAR = TAR.IDINSTTAR
    INNER JOIN cmd_act_hi_actinst C ON (C.TASK_ID_ = TAR.IDINSTTAR)
    LEFT JOIN TSIUSU USU ON (TAR.CODUSUDONO = USU.CODUSU)
    WHERE TAR.IDINSTPRN = TB.IDINSTPRN
    AND 
    (
    C.ACT_TYPE_ LIKE 'userTask'
    )
    ORDER BY TAR.DHCRIACAO DESC) AS TAREFA_ATUAL
    ,TB.*
    FROM
    (
    SELECT 
    CAB.IDINSTPRN
    ,STUFF(
                     (SELECT DISTINCT ','
    						+ CONVERT(VARCHAR(100),CT.NUMCOTACAO)
    					FROM TGFCOT CT
    					WHERE CT.AD_IDINSTPRN = CAB.IDINSTPRN FOR XML PATH ('')), 1, 1, ''
                   ) AS COTACOES
    ,STUFF(
                     (SELECT DISTINCT ','
    						+ CONVERT(VARCHAR(100),CB.NUNOTA)
    					FROM TGFCAB CB
    					WHERE
    					CB.TIPMOV = 'O'
    					AND CB.AD_IDINSTPRN = CAB.IDINSTPRN FOR XML PATH ('')), 1, 1, ''
                   ) AS PEDIDOS
    ,STUFF(
                     (SELECT DISTINCT ','
    						+ CONVERT(VARCHAR(100),CB1.NUMNOTA)
    					FROM TGFVAR VA
                        LEFT JOIN TGFCAB CB ON VA.NUNOTAORIG = CB.NUNOTA
                        LEFT JOIN TGFCAB CB1 ON CB1.NUNOTA = VA.NUNOTA
                        WHERE CB.AD_IDINSTPRN = CAB.IDINSTPRN FOR XML PATH ('')), 1, 1, ''
                   ) AS NOTAS

    ,(SELECT MAX(RN.VERSAO) FROM TWFIPRN RN WHERE RN.IDINSTPRN = CAB.IDINSTPRN) AS VERSAO
    ,(SELECT DHINCLUSAO FROM TWFIPRN RN WHERE RN.IDINSTPRN = CAB.IDINSTPRN) AS DHINCLUSAO
    ,USU.NOMEUSU AS EXECUTIVO
    ,(SELECT NOMEUSU FROM TSIUSU WHERE CODUSU = PRN.CODUSUINC) AS SOLICITANTE
    ,CAB.IDINSTTAR
    ,CAB.CODCENCUS, CUS.DESCRCENCUS
    ,CAB.CODNAT, NAT.DESCRNAT
    ,CAB.CODPARC
    ,CAB.JUSTIFICATIVA
    ,CAB.DTNEG AS DTSOLICIT
    ,CASE WHEN PRN.CODPRN = 17 THEN 'AdesÃ£o a Credenciamento' 
    ELSE (select OPC.OPCAO from tddcam cam
    inner join tddopc opc on opc.NUCAMPO = cam.NUCAMPO
    where CAM.nometab = 'AD_REQUISICAOCOMPRA'
    AND CAM.NOMECAMPO = 'PROCESSO'
    AND OPC.VALOR = CAB.PROCESSO) END AS PROCESSADO
        ,CASE WHEN CAO.SITUACAO = 'SA' THEN 'APROVADA' 
        WHEN CAO.SITUACAO = 'SR' THEN 'REPROVADA'
        WHEN CAO.SITUACAO = 'RA' THEN 'AJUSTE'
        ELSE '' END AS SITUACAO
        ,CAO.OBSERVACAOAPRO
        ,CASE WHEN CAO.SITUADIR = 'A' THEN 'APROVADA' 
        WHEN CAO.SITUADIR = 'R' THEN 'REPROVADA'
        WHEN CAO.SITUADIR = 'AJ' THEN 'AJUSTE'
        ELSE '' END AS SITUADIR
        ,CAO.OBSDIR
        ,CASE WHEN CAO.APROVACT = 'S' THEN 'APROVADA' 
        WHEN CAO.APROVACT = 'N' THEN 'REPROVADA'
        WHEN CAO.APROVACT = 'A' THEN 'AJUSTE'
        ELSE '' END AS APROVACT
        ,CAO.APROVACT_OBS
        ,CASE WHEN CAB.ANALIJUR = 'A' OR CAO.APROVJUR = 'A' THEN 'APROVADA' 
        WHEN CAB.ANALIJUR = 'R' OR CAO.APROVJUR = 'R' THEN 'REPROVADA'
        WHEN CAB.ANALIJUR IN ('C','CJ','J') OR CAO.APROVJUR = 'AJ' THEN 'AJUSTE'
        ELSE '' END AS ANALIJUR
        ,ISNULL(CAB.OBSANALIJUR,CAO.OBSERVJUR) AS OBSANALIJUR
        ,CASE WHEN PRN.SITUACAOEXEC = 'F' THEN 'FINALIZADA' 
        WHEN PRN.SITUACAOEXEC = 'C' THEN 'CANCELADA'
        WHEN PRN.SITUACAOEXEC = 'I' THEN 'EM ANDAMENTO'
        ELSE '' END AS SITUACAOEXEC
        ,PRN.OBSCANCEL
        ,PRN.CODUSUCANCEL
        ,PRN.CODPRN
            ,(SELECT NOMEUSU FROM TSIUSU WHERE CODUSU = PRN.CODUSUCANCEL) AS USUCANCEL
        ,(SELECT SUM(VLRTOT) FROM AD_REQUISICAOCOMPRAITENS ITENS WHERE ITENS.IDINSTPRN = CAB.IDINSTPRN) AS VLRRC
        ,(SELECT SUM(VLRNOTA) FROM TGFCAB CB WHERE CB.AD_IDINSTPRN = CAB.IDINSTPRN AND TIPMOV = 'O') AS VLRPED
        ,(SELECT MAX(DHBAIXA) FROM TGFFIN FIN INNER JOIN TGFCAB CB ON FIN.NUNOTA = CB.NUNOTA WHERE CB.AD_IDINSTPRN = CAB.IDINSTPRN AND FIN.DHBAIXA IS NOT NULL) AS DHBAIXA
    FROM AD_REQUISICAOCOMPRA CAB
        INNER JOIN TWFIPRN PRN ON CAB.IDINSTPRN = PRN.IDINSTPRN
    INNER JOIN TSICUS CUS ON CUS.CODCENCUS = CAB.CODCENCUS
    INNER JOIN TGFNAT NAT ON NAT.CODNAT = CAB.CODNAT
    INNER JOIN TSIUSU USU ON USU.CODUSU = CAB.CODUSUCR
    INNER JOIN TSIUSU USU1 ON USU1.CODUSU = CAB.CODUSU
    LEFT JOIN AD_APROVACAO CAO ON CAO.IDINSTPRN = CAB.IDINSTPRN
    -->LEFT JOIN AD_REQUISICAOCOMPRAITENS ITE ON CAB.IDINSTPRN = ITE.IDINSTPRN AND CAB.IDINSTTAR = ITE.IDINSTTAR
    -->LEFT JOIN TGFPRO PRO ON PRO.CODPROD = ITE.CODPROD
    
    UNION ALL
    
    SELECT 
    CAB.IDINSTPRN
    ,STUFF(
                     (SELECT DISTINCT ','
    						+ CONVERT(VARCHAR(100),CT.NUMCOTACAO)
    					FROM TGFCOT CT
    					WHERE CT.AD_IDINSTPRN = CAB.IDINSTPRN FOR XML PATH ('')), 1, 1, ''
                   ) AS COTACOES
    ,STUFF(
                     (SELECT DISTINCT ','
    						+ CONVERT(VARCHAR(100),CB.NUNOTA)
    					FROM TGFCAB CB
    					WHERE
    					CB.TIPMOV = 'O'
    					AND CB.AD_IDINSTPRN = CAB.IDINSTPRN FOR XML PATH ('')), 1, 1, ''
                   ) AS PEDIDOS
    ,STUFF(
                     (SELECT DISTINCT ','
    						+ CONVERT(VARCHAR(100),CB.NUmNOTA)
    					FROM TGFCAB CB
    					WHERE
    					CB.TIPMOV = 'C'
    					AND CB.AD_IDINSTPRN = CAB.IDINSTPRN FOR XML PATH ('')), 1, 1, ''
                   ) AS NOTAS
    ,(SELECT MAX(RN.VERSAO) FROM TWFIPRN RN WHERE RN.IDINSTPRN = CAB.IDINSTPRN) AS VERSAO
    ,(SELECT DHINCLUSAO FROM TWFIPRN RN WHERE RN.IDINSTPRN = CAB.IDINSTPRN) AS DHINCLUSAO
    ,'' AS EXECUTIVO
    ,(SELECT NOMEUSU FROM TSIUSU WHERE CODUSU = PRN.CODUSUINC) AS SOLICITANTE
    ,CAB.IDINSTTAR
    ,CAB.CODCENCUS, CUS.DESCRCENCUS
    ,CAB.CODNAT, NAT.DESCRNAT
    ,CAB.CODPARC
    ,CAB.JUSTIFICATIVA
    ,'' AS DTSOLICIT
    ,'' AS PROCESSADO
    ,'' AS SITUACAO
    ,'' AS OBSERVACAOAPRO
    ,'' AS SITUADIR
    ,'' AS OBSDIR   
    ,'' AS APROVACT
    ,'' AS APROVACT_OBS   
    ,'' AS ANALIJUR
    ,'' AS OBSANALIJUR 
    ,CASE WHEN PRN.SITUACAOEXEC = 'F' THEN 'FINALIZADA' 
        WHEN PRN.SITUACAOEXEC = 'C' THEN 'CANCELADA'
        WHEN PRN.SITUACAOEXEC = 'I' THEN 'EM ANDAMENTO'
        ELSE '' END AS SITUACAOEXEC
    ,PRN.OBSCANCEL
    ,PRN.CODUSUCANCEL
    ,PRN.CODPRN
    ,(SELECT NOMEUSU FROM TSIUSU WHERE CODUSU = PRN.CODUSUCANCEL) AS USUCANCEL
    ,(SELECT SUM(VLRTOT) FROM AD_REQUISICAOCOMPRAITENS ITENS WHERE ITENS.IDINSTPRN = CAB.IDINSTPRN) AS VLRRC
    ,(SELECT SUM(VLRNOTA) FROM TGFCAB CB WHERE CB.AD_IDINSTPRN = CAB.IDINSTPRN AND TIPMOV = 'O') AS VLRPED
,(SELECT MAX(DHBAIXA) FROM TGFFIN FIN INNER JOIN TGFCAB CB ON FIN.NUNOTA = CB.NUNOTA WHERE CB.AD_IDINSTPRN = CAB.IDINSTPRN AND FIN.DHBAIXA IS NOT NULL) AS DHBAIXA    FROM AD_FATCON CAB
    INNER JOIN TSICUS CUS ON CUS.CODCENCUS = CAB.CODCENCUS
    INNER JOIN TGFNAT NAT ON NAT.CODNAT = CAB.CODNAT
    INNER JOIN TWFIPRN PRN ON PRN.IDINSTPRN = CAB.IDINSTPRN
    --INNER JOIN TSIUSU USU ON USU.CODUSU = CAB.CODUSUCR
    INNER JOIN TSIUSU USU1 ON USU1.CODUSU = PRN.CODUSUINC
    -->LEFT JOIN AD_REQUISICAOCOMPRAITENS ITE ON CAB.IDINSTPRN = ITE.IDINSTPRN AND CAB.IDINSTTAR = ITE.IDINSTTAR
    -->LEFT JOIN TGFPRO PRO ON PRO.CODPROD = ITE.CODPROD
    
    UNION ALL
    
    SELECT 
    CAB.IDINSTPRN
    ,STUFF(
                     (SELECT DISTINCT ','
    						+ CONVERT(VARCHAR(100),CT.NUMCOTACAO)
    					FROM TGFCOT CT
    					WHERE CT.AD_IDINSTPRN = CAB.IDINSTPRN FOR XML PATH ('')), 1, 1, ''
                   ) AS COTACOES
    ,STUFF(
                     (SELECT DISTINCT ','
    						+ CONVERT(VARCHAR(100),CB.NUNOTA)
    					FROM TGFCAB CB
    					WHERE
    					CB.TIPMOV = 'O'
    					AND CB.AD_IDINSTPRN = CAB.IDINSTPRN FOR XML PATH ('')), 1, 1, ''
                   ) AS PEDIDOS
    ,STUFF(
                     (SELECT DISTINCT ','
    						+ CONVERT(VARCHAR(100),CB.NUmNOTA)
    					FROM TGFCAB CB
    					WHERE
    					CB.TIPMOV = 'C'
    					AND CB.AD_IDINSTPRN = CAB.IDINSTPRN FOR XML PATH ('')), 1, 1, ''
                   ) AS NOTAS
    ,(SELECT MAX(RN.VERSAO) FROM TWFIPRN RN WHERE RN.IDINSTPRN = CAB.IDINSTPRN) AS VERSAO
    ,(SELECT DHINCLUSAO FROM TWFIPRN RN WHERE RN.IDINSTPRN = CAB.IDINSTPRN) AS DHINCLUSAO
    ,'' AS EXECUTIVO
    ,(SELECT NOMEUSU FROM TSIUSU WHERE CODUSU = PRN.CODUSUINC) AS SOLICITANTE
    ,CAB.IDINSTTAR
    ,CAB.CODCENCUS, CUS.DESCRCENCUS
    ,CAB.CODNAT, NAT.DESCRNAT
    ,CAB.CODPARC
    ,CAB.JUSTIFICATIVA
    ,'' AS DTSOLICIT
    ,'' AS PROCESSADO
    ,'' AS SITUACAO
    ,'' AS OBSERVACAOAPRO
    ,'' AS SITUADIR
    ,'' AS OBSDIR   
    ,'' AS APROVACT
    ,'' AS APROVACT_OBS   
    ,'' AS ANALIJUR
    ,'' AS OBSANALIJUR 
    ,CASE WHEN PRN.SITUACAOEXEC = 'F' THEN 'FINALIZADA' 
        WHEN PRN.SITUACAOEXEC = 'C' THEN 'CANCELADA'
        WHEN PRN.SITUACAOEXEC = 'I' THEN 'EM ANDAMENTO'
        ELSE '' END AS SITUACAOEXEC
  ,PRN.OBSCANCEL
    ,PRN.CODPRN
    ,PRN.CODUSUCANCEL
    ,(SELECT NOMEUSU FROM TSIUSU WHERE CODUSU = PRN.CODUSUCANCEL) AS USUCANCEL
    ,(SELECT SUM(VLRTOT) FROM AD_REQUISICAOCOMPRAITENS ITENS WHERE ITENS.IDINSTPRN = CAB.IDINSTPRN) AS VLRRC
    ,(SELECT SUM(VLRNOTA) FROM TGFCAB CB WHERE CB.AD_IDINSTPRN = CAB.IDINSTPRN AND TIPMOV = 'O') AS VLRPED
,(SELECT MAX(DHBAIXA) FROM TGFFIN FIN INNER JOIN TGFCAB CB ON FIN.NUNOTA = CB.NUNOTA WHERE CB.AD_IDINSTPRN = CAB.IDINSTPRN AND FIN.DHBAIXA IS NOT NULL) AS DHBAIXA    FROM AD_FLXDEP CAB
    INNER JOIN TSICUS CUS ON CUS.CODCENCUS = CAB.CODCENCUS
    INNER JOIN TGFNAT NAT ON NAT.CODNAT = CAB.CODNAT
    INNER JOIN TWFIPRN PRN ON PRN.IDINSTPRN = CAB.IDINSTPRN
    --INNER JOIN TSIUSU USU ON USU.CODUSU = CAB.CODUSUCR
    INNER JOIN TSIUSU USU1 ON USU1.CODUSU = PRN.CODUSUINC
    -->LEFT JOIN AD_REQUISICAOCOMPRAITENS ITE ON CAB.IDINSTPRN = ITE.IDINSTPRN AND CAB.IDINSTTAR = ITE.IDINSTTAR
    -->LEFT JOIN TGFPRO PRO ON PRO.CODPROD = ITE.CODPROD
    
    
    ) TB
    WHERE
    (TB.IDINSTPRN = :PROC OR :PROC IS NULL)
    AND
    (TB.CODNAT = :NATUREZA OR :NATUREZA IS NULL)
    AND
    (TB.CODCENCUS = :CENCUS OR :CENCUS IS NULL)
    AND
    (TB.IDINSTPRN IN (SELECT AD_IDINSTPRN FROM TGFCAB WHERE NUNOTA = :PEDIDO) OR :PEDIDO IS NULL)
    AND
    (TB.IDINSTPRN IN (SELECT AD_IDINSTPRN FROM TGFCAB WHERE NUNOTA = :NOTA) OR :NOTA IS NULL)
    AND
    (TB.IDINSTPRN IN (SELECT AD_IDINSTPRN FROM TGFCOT WHERE NUMCOTACAO = :COTACAO) OR :COTACAO IS NULL)
    ORDER BY TB.IDINSTPRN ASC
